<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stream Boss ‚Äî –û–≤–µ—Ä–ª–µ–π</title>
  <style>
    :root{
      --bg: rgba(0,0,0,0.0);
      --card: rgba(45,10,53,0.80);
      --accent: #ff57f0;
      --text: #f7ecff;
      --muted: #c9aee1;
      --danger: #ff4d6d;
      --good: #54ff9f;
      --shadow: 0 12px 42px rgba(0,0,0,0.45), 0 0 80px rgba(255,87,240,0.12) inset;
    }

    html,body{ height:100%; width:100%; margin:0; padding:0; background: var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Inter, sans-serif; color: var(--text); }
    .stage{ position:relative; width:1920px; height:1080px; margin:0 auto; overflow:hidden; }

    /* TITLE ONLY PASS */
    .titleOnly{ position:absolute; left:0; right:0; top:-50%; display:flex; flex-direction:column; align-items:center; gap:14px; pointer-events:none; z-index: 5; }
    .tiny{ font-size:28px; letter-spacing:.8px; text-transform:uppercase; color:var(--muted); text-shadow:0 6px 24px rgba(0,0,0,0.45); }
    .big{ font-size:100px; font-weight:1000; letter-spacing:1px; text-shadow:0 10px 28px rgba(0,0,0,0.55); }
    @keyframes titlePass { 0% { top:-50%; } 100% { top:110%; } }
    .titlePlay{ animation: titlePass 7.5s linear forwards; }

    /* BOSS CARD */
    .boss-card{ position:absolute; left:38%; top:24px; transform:translate(-50%,-140%); width:1200px; padding:18px 24px 24px; background: var(--card); border:1px solid rgba(255,255,255,0.1); border-radius:20px; box-shadow: var(--shadow); backdrop-filter: blur(8px); overflow:visible; opacity:0; z-index: 3; transition: opacity .35s ease, transform .35s ease; }
    @keyframes cardDown { from { transform:translate(-50%,-140%); opacity:0; } to { transform:translate(-50%,0); opacity:1; } }

    .hpArea{ position: relative; height: 70px; border-radius: 16px; overflow: hidden; border:1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,87,240,0.18), rgba(0,0,0,0.35)); margin: 6px 0 12px; }
    .hpBar{ --hp: 1; position:absolute; inset:0; width: calc(var(--hp) * 100%); background: linear-gradient(90deg, rgba(255,87,240,0.9), rgba(255,87,240,0.4)); box-shadow: 0 0 36px rgba(255,87,240,0.5); transition: width 260ms ease, filter 260ms ease; }
    .hpNum{ position:absolute; left:50%; top:50%; transform: translate(-50%,-50%); font-weight: 1000; font-size: 32px; letter-spacing: .5px; text-shadow: 0 2px 10px rgba(0,0,0,0.7); }

    .bossNameUnder{ text-align:center; font-size: 56px; font-weight: 1000; margin: 10px 0 6px; text-shadow:0 10px 28px rgba(0,0,0,0.55); }

    .bossStage{ display:flex; align-items:center; justify-content:center; min-height: 260px; position: relative; }
    .bossImgWrap{ position: relative; display:inline-flex; align-items:center; justify-content:center; padding:10px; border-radius: 16px; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35); opacity:0; will-change: transform, opacity; }
    .bossImg{ width: 360px; height: 220px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.45)); }
    .bossEmoji{ font-size: 180px; line-height: 1; }

    @keyframes dropIn { 0% { transform: translateY(-40px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    @keyframes shake { 0%{ transform: translate(0,0) rotate(0); } 20%{ transform: translate(-6px,2px) rotate(-2deg); } 40%{ transform: translate(6px,-2px) rotate(2deg); } 60%{ transform: translate(-4px,1px) rotate(-1.2deg); } 80%{ transform: translate(4px,-1px) rotate(1.2deg); } 100%{ transform: translate(0,0) rotate(0); } }
    .shakeOnce{ animation: shake 650ms ease; }

    /* boss hit */
    @keyframes bossHit { 
      0%   { transform: translate(0,0) scale(1); filter: brightness(1); }
      25%  { transform: translate(-10px,4px) rotate(-2.2deg) scale(1.03); filter: brightness(1.18); }
      50%  { transform: translate(10px,-4px) rotate(2.2deg) scale(0.99);  }
      75%  { transform: translate(-6px,2px) rotate(-1.2deg) scale(1.01); }
      100% { transform: translate(0,0) scale(1); filter: brightness(1); }
    }
    .bossHit{ animation: bossHit 260ms ease; }

    @keyframes chunk { from { transform: translateY(-6px); opacity: 1; } to { transform: translateY(-26px); opacity: 0; } }
    .floaters{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .floater{ position:absolute; font-weight:900; font-size:24px; color: var(--good); text-shadow: 0 0 10px rgba(84,255,159,0.7); animation: chunk 800ms ease-out forwards; }
    .floater.neg{ color: var(--danger); text-shadow: 0 0 10px rgba(255,77,109,0.7); }

    /* Buttons */
    .buttons{ position:absolute; left:50%; bottom:24px; transform: translate(-50%,140%); display:grid; grid-template-columns: repeat(2, minmax(360px, 1fr)); gap:18px 24px; justify-content:center; padding:16px; background: rgba(0,0,0,0.30); border:1px solid rgba(255,255,255,0.1); border-radius:14px; backdrop-filter: blur(6px); opacity:0; z-index:4; transition: opacity .35s ease, transform .35s ease; }
    .btn{ user-select:none; cursor:pointer; padding:18px 20px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); font-weight:1000; font-size:20px; text-align:center; }
    @keyframes slideUp { from { transform: translate(-50%,140%); opacity:0; } to { transform: translate(-50%,0); opacity:1; } }

    /* Fullscreen storm */
    .storm{ position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index: 6; }
    .r{ position:absolute; width:2px; height:28px; background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0)); border-radius:2px; transform: rotate(22deg) translate(0,0); opacity:0.85; will-change: transform; animation: blow var(--dur,1.4s) linear forwards; }
    @keyframes blow { to { transform: rotate(22deg) translate(-180vw, 180vh); opacity: 0; } }

    /* Defeat + confetti */
    .defeat{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index: 12; opacity:0; }
    .defeat.show{ animation: fadeIn .6s ease forwards, fadeOut 1s ease 5.5s forwards; }
    @keyframes fadeIn { from{ opacity:0; } to{ opacity:1; } }
    @keyframes fadeOut { to{ opacity:0; } }
    .defeatText{ font-size: 86px; font-weight: 1000; letter-spacing: 1.6px; text-transform: uppercase; text-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .confetti{ position:absolute; inset:0; overflow:hidden; pointer-events:none; z-index: 11; }
    .c{ position:absolute; width:10px; height:14px; background: #fff; opacity:.95; will-change: transform; border-radius:2px; }
    @keyframes fall { to { transform: translateY(120vh) rotate(600deg); opacity: 1; } }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="titleOnly" id="titleOnly">
      <div class="tiny" id="tTiny">–°–ï–ó–û–ù 0 | —Ö–µ–ª–ª–æ—É–∏–Ω—Å–∫–∏ –ø–æ—Ä—Ç–∞–ª</div>
      <div class="big" id="tBig">–°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ï</div>
    </div>

    <div class="boss-card" id="card">
      <div class="hpArea">
        <div class="hpBar" id="hpBar"></div>
        <div class="hpNum" id="hpNum">HP: 500 / 500</div>
        <div class="floaters" id="floaters"></div>
      </div>
      <div class="bossNameUnder" id="bossName">–¢—É–Ω–≥ –¢—É–Ω–≥ –¢—É–Ω–≥ –°–∞—É—Ä</div>
      <div class="bossStage">
        <div class="bossImgWrap" id="bossWrap">
          <img id="bossImg" class="bossImg" alt="–ë–æ—Å—Å">
          <div id="bossEmoji" class="bossEmoji">üß†</div>
        </div>
      </div>
    </div>

    <div class="buttons" id="buttons"></div>

    <div class="storm" id="storm"></div>
    <div class="confetti" id="confetti"></div>
    <div class="defeat" id="defeat"><div class="defeatText">–ë–û–°–° –ü–û–ë–ï–ñ–î–ï–ù</div></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyADwdDLpb5Qb2fuDx5vWC3-_BAX4S7ZiJk",
      authDomain: "mini-app-adventure.firebaseapp.com",
      projectId: "mini-app-adventure",
      storageBucket: "mini-app-adventure.firebasestorage.app",
      messagingSenderId: "537034908749",
      appId: "1:537034908749:web:26edebdf7d9fa2b42a2804",
      measurementId: "G-0RF2PPHQN8"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const els = {
      stage: document.getElementById('stage'),
      titleOnly: document.getElementById('titleOnly'),
      tTiny: document.getElementById('tTiny'),
      tBig: document.getElementById('tBig'),
      card: document.getElementById('card'),
      hpBar: document.getElementById('hpBar'),
      hpNum: document.getElementById('hpNum'),
      floaters: document.getElementById('floaters'),
      bossWrap: document.getElementById('bossWrap'),
      bossImg: document.getElementById('bossImg'),
      bossEmoji: document.getElementById('bossEmoji'),
      bossName: document.getElementById('bossName'),
      buttons: document.getElementById('buttons'),
      storm: document.getElementById('storm'),
      defeat: document.getElementById('defeat'),
      confetti: document.getElementById('confetti'),
    };

    const LS_KEY = 'bossState_v15';
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(e){ return null; } }

    const defaults = {
      boss: qs.get('boss') || '–¢—É–Ω–≥ –¢—É–Ω–≥ –¢—É–Ω–≥ –°–∞—É—Ä',
      max: clamp(parseInt(qs.get('max')) || 500, 1, 999999),
      subtitle: qs.get('subtitle') || '–°–ï–ó–û–ù 0 | —Ö–µ–ª–ª–æ—É–∏–Ω—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª',
      titlebig: qs.get('titlebig') || '–°–¢–û–õ–ö–ù–û–í–ï–ù–ò–ï',
      boss_img: qs.get('boss_img') || 'https://i.imgur.com/hwJZoMX.png',
      x: parseFloat(qs.get('x')) || 38,
      w: clamp(parseInt(qs.get('w')) || 1200, 800, 1720),
      auto_restart: (qs.get('auto_restart') || '0') === '1',
    };
    let state = load() || { boss: defaults.boss, max: defaults.max, hp: defaults.max, subtitle: defaults.subtitle, titlebig: defaults.titlebig, x: defaults.x, w: defaults.w, defeated:false };

    function applyLayout(){
      els.card.style.left = (state.x || 38) + '%';
      els.card.style.width = (state.w || 1200) + 'px';
      const rect = els.card.getBoundingClientRect();
      els.buttons.style.left = (rect.left + rect.width/2) + 'px';
    }

    function render(){
      els.bossName.textContent = state.boss;
      els.tTiny.textContent = state.subtitle;
      els.tBig.textContent = state.titlebig;
      const ratio = clamp(state.hp / state.max, 0, 1);
      els.hpBar.style.setProperty('--hp', ratio);
      els.hpNum.textContent = `HP: ${state.hp} / ${state.max}`;
      els.bossImg.src = defaults.boss_img || '';
      els.bossImg.style.display = 'block';
      els.bossEmoji.style.display = 'none';
      applyLayout();
      save();
    }

    function floater(txt, isNeg){
      const n = document.createElement('div');
      n.className = 'floater' + (isNeg ? ' neg' : '');
      n.textContent = txt;
      n.style.left = (10 + Math.random()*80) + '%';
      n.style.top = (20 + Math.random()*50) + '%';
      els.floaters.appendChild(n);
      setTimeout(()=> n.remove(), 900);
    }

    function bossHit(){
      els.bossWrap.classList.remove('bossHit'); void els.bossWrap.offsetWidth;
      els.bossWrap.classList.add('bossHit');
      setTimeout(()=> els.bossWrap.classList.remove('bossHit'), 300);
    }

    function damage(d){
      if(state.defeated) return;
      const before = state.hp;
      state.hp = clamp(state.hp - Math.abs(d), 0, state.max);
      render();
      floater(`-${Math.abs(d)}`, false);
      if(state.hp > 0) bossHit();
      if(before > 0 && state.hp === 0){ triggerDefeat(); }
    }

    // Storm visuals / tick damage
    let stormEndTimeout = null, stormDropsInterval = null, stormDamageInterval = null;
    function stopStorm(){ if(stormEndTimeout){clearTimeout(stormEndTimeout);} if(stormDropsInterval){clearInterval(stormDropsInterval);} if(stormDamageInterval){clearInterval(stormDamageInterval);} els.storm.innerHTML=''; }
    function spawnDrops(count){
      for(let i=0;i<count;i++){
        const d = document.createElement('div'); d.className='r';
        d.style.top = (-30 + Math.random()*160) + '%';
        d.style.left= (100 + Math.random()*40) + '%';
        d.style.height = (16 + Math.random()*36) + 'px';
        d.style.setProperty('--dur', (1.0 + Math.random()*1.8) + 's');
        d.style.opacity = (0.35 + Math.random()*0.65).toFixed(2);
        els.storm.appendChild(d); setTimeout(()=> d.remove(), 3000);
      }
    }
    function tickDamage(total){
      if(state.defeated) return;
      stopStorm(); spawnDrops(220);
      let left = Math.max(1, Math.floor(total));
      stormDamageInterval = setInterval(()=>{
        if(left<=0 || state.hp<=0){ clearInterval(stormDamageInterval); stormDamageInterval=null; stopStorm(); return; }
        const t = Math.min(left, (Math.random()<0.5?1:2));
        damage(t); left -= t;
      }, 100);
      stormEndTimeout = setTimeout(()=>{ stopStorm(); }, 6000);
      stormDropsInterval = setInterval(()=> spawnDrops(160), 200);
    }

    function clearAnim(el){ el.style.animation='none'; void el.offsetWidth; el.style.animation=''; }

    const CONF_COLS = ['#ff6b6b','#ffd93d','#6bcB77','#4D96FF','#B892FF','#FF8FAB','#F8F9FA'];
    function spawnConfetti(n){
      for(let i=0;i<n;i++){
        const piece = document.createElement('div'); piece.className='c';
        const x = Math.random()*100, delay = Math.random()*0.4, dur = 1.8 + Math.random()*1.8, clr = CONF_COLS[(Math.random()*CONF_COLS.length)|0], size = 8 + Math.random()*10;
        piece.style.left = x + '%'; piece.style.top = (-10 + Math.random()*10) + '%';
        piece.style.background = clr; piece.style.width = size + 'px'; piece.style.height = (size*1.2) + 'px';
        piece.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`; piece.style.animation = `fall ${dur}s ease-in ${delay}s forwards`;
        els.confetti.appendChild(piece); setTimeout(()=> piece.remove(), (dur+delay+0.2)*1000);
      }
    }

    function triggerDefeat(){
      state.defeated = true; save(); stopStorm();
      clearAnim(els.buttons); clearAnim(els.bossWrap); clearAnim(els.card);
      els.bossWrap.style.transition = 'transform .35s ease, opacity .35s ease';
      els.bossWrap.style.transform = 'scale(.85) translateY(-12px)'; els.bossWrap.style.opacity = '0';
      els.buttons.style.transition = 'opacity .35s ease, transform .35s ease';
      els.buttons.style.opacity = '0'; els.buttons.style.transform = 'translate(-50%,140%)'; els.buttons.style.pointerEvents = 'none';
      els.card.style.opacity = '0.0'; els.card.style.transform = 'translate(-50%,-18px)';
      setTimeout(()=>{ els.defeat.classList.remove('show'); void els.defeat.offsetWidth; els.defeat.classList.add('show'); spawnConfetti(260); const confTimer = setInterval(()=> spawnConfetti(140), 300); setTimeout(()=> clearInterval(confTimer), 3000); }, 450);
      if(defaults.auto_restart){ setTimeout(()=>{ state.hp = state.max; state.defeated = false; save(); playIntro(); }, 6200); }
    }

    function applyQuery(){
      const name = qs.get('boss'), max = qs.get('max'), subtitle = qs.get('subtitle'), titlebig = qs.get('titlebig'), img = qs.get('boss_img'), x = qs.get('x'), w = qs.get('w'), ar = qs.get('auto_restart');
      if(name) state.boss = decodeURIComponent(name);
      if(max) state.max = clamp(parseInt(max)||state.max, 1, 999999);
      if(subtitle) state.subtitle = decodeURIComponent(subtitle);
      if(titlebig) state.titlebig = decodeURIComponent(titlebig);
      if(img) { defaults.boss_img = img; }
      if(x){ state.x = parseFloat(x) || state.x; }
      if(w){ state.w = clamp(parseInt(w)||state.w, 800, 1720); }
      if(ar !== null){ defaults.auto_restart = (ar === '1'); }
      if(state.hp > state.max) state.hp = state.max;
    }

    function playIntro(){
      stopStorm();
      els.defeat.classList.remove('show'); els.confetti.innerHTML = '';
      els.card.style.opacity='1'; els.card.style.transform='translate(-50%,0)';
      els.bossWrap.style.opacity='1'; els.buttons.style.opacity='1'; els.buttons.style.transform='translate(-50%,0)'; els.buttons.style.pointerEvents='auto';
      if(state.hp <= 0){ state.hp = state.max; } state.defeated = false; save(); render();

      els.titleOnly.classList.remove('titlePlay');
      els.card.style.animation='none'; els.buttons.style.animation='none';
      els.card.style.opacity='0'; els.buttons.style.opacity='0';
      els.card.style.transform='translate(-50%,-140%)'; els.buttons.style.transform='translate(-50%,140%)';
      els.card.style.pointerEvents='none'; els.buttons.style.pointerEvents='none';
      els.tTiny.textContent = state.subtitle; els.tBig.textContent = state.titlebig;
      requestAnimationFrame(()=>{ els.titleOnly.classList.add('titlePlay'); });
      setTimeout(()=>{
        els.card.style.animation = 'cardDown 650ms ease forwards';
        setTimeout(()=>{ els.card.style.transform='translate(-50%,0)'; els.card.style.opacity='1'; els.bossWrap.style.animation='dropIn 650ms ease forwards'; setTimeout(()=>{ els.bossWrap.style.animation=''; els.bossWrap.style.opacity='1'; }, 700); applyLayout(); }, 650);
        els.buttons.style.animation = 'slideUp 650ms ease forwards';
        setTimeout(()=>{ els.card.style.pointerEvents='auto'; els.buttons.style.pointerEvents='auto'; }, 700);
      }, 7500);
    }

    window.addEventListener('resize', applyLayout);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible'){ playIntro(); } });

    function renderButtons(actions=[], extra=null){
      const box = els.buttons; box.innerHTML = '';
      (actions||[]).forEach(a=>{
        const div = document.createElement('div'); div.className='btn';
        div.textContent = `${a.label} ‚Äî ‚àí${a.dmg} HP`;
        div.addEventListener('click', ()=> damage(Number(a.dmg)||0));
        box.appendChild(div);
      });
      if (extra && extra.label && Number(extra.total)>0){
        const div = document.createElement('div'); div.className='btn';
        div.textContent = `${extra.label} ‚Äî ‚àí${extra.total} HP (—Ç–∏–∫–∏)`;
        div.addEventListener('click', ()=> tickDamage(Number(extra.total)||0));
        box.appendChild(div);
      }
    }

    // Init overlay
    applyQuery(); render(); playIntro();

    // –í OBS: —Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ)
    const remoteOnly = qs.get('remote_only') === '1';
    if(remoteOnly){ els.buttons.style.pointerEvents = 'none'; }

    // Firestore Live
    const roomId = qs.get('room') || 'demo';
    const roomRef = doc(db, 'rooms', roomId);

    let lastCmdAt = 0;
    onSnapshot(roomRef, (snap) => {
      if (!snap.exists()) return;
      const d = snap.data();

      // —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const fields = ['boss','max','hp','subtitle','titlebig','x','w','defeated','auto_restart','boss_img'];
      for (const k of fields) {
        if (d[k] !== undefined) { if (k === 'boss_img') { defaults.boss_img = d[k]; } else { state[k] = d[k]; } }
      }
      if (state.hp > state.max) state.hp = state.max;
      render();

      // –∫–Ω–æ–ø–∫–∏ –∏–∑ Firestore
      const actions = Array.isArray(d.actions) ? d.actions.filter(x=>x?.label && Number(x?.dmg)>0).slice(0,5) : [];
      const extra   = d.extraSkill && d.extraSkill.label && Number(d.extraSkill.total)>0 ? d.extraSkill : null;
      renderButtons(actions, extra);

      // –∫–æ–º–∞–Ω–¥—ã
      const cmd = d.cmd;
      const ts = cmd && cmd.at && typeof cmd.at.toMillis === 'function' ? cmd.at.toMillis() : 0;
      if (ts && ts > lastCmdAt) {
        lastCmdAt = ts;
        if (cmd.type === 'damage') damage(Math.abs(cmd.amount || 0));
        if (cmd.type === 'tick' && Number(cmd.total)>0) tickDamage(Number(cmd.total));
        if (cmd.type === 'set' && cmd.patch){ Object.assign(state, cmd.patch||{}); render(); }
      }
    });
  </script>
</body>
</html>
