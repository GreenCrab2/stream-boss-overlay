<!DOCTYPE html>


<!-- ðŸ”Œ Firebase listener: Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Firestore, Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ Ð¿Ð°Ñ‚Ñ‡Ð¸/ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


// â¬‡ï¸ Ð—ÐÐœÐ•ÐÐ˜ Ð½Ð° ÑÐ²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¸Ð· Firebase Console
const firebaseConfig = {
apiKey: "/* YOUR CONFIG HERE */",
authDomain: "/* YOUR CONFIG HERE */",
projectId: "/* YOUR CONFIG HERE */",
storageBucket: "/* YOUR CONFIG HERE */",
messagingSenderId: "/* YOUR CONFIG HERE */",
appId: "/* YOUR CONFIG HERE */"
};


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


const qs = new URLSearchParams(location.search);
const roomId = qs.get('room') || 'demo';
const roomRef = doc(db, 'rooms', roomId);


// Ð ÐµÐ¶Ð¸Ð¼ Ð´Ð»Ñ OBS: ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ñ…Ð¾Ñ‚ÐºÐµÐ¸
if (qs.get('remote_only') === '1') {
try { document.onkeydown = null; } catch(_) {}
try { els.buttons.style.display = 'none'; } catch(_) {}
}


let lastCmdAt = 0;
onSnapshot(roomRef, (snap) => {
if (!snap.exists()) return;
const d = snap.data();


// ÐŸÐ°Ñ‚Ñ‡ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
const fields = ['boss','max','hp','subtitle','titlebig','x','w','defeated','auto_restart','boss_img'];
for (const k of fields) {
if (d[k] !== undefined) {
if (k === 'boss_img') {
if (typeof defaults !== 'undefined') defaults.boss_img = d[k];
} else if (typeof state !== 'undefined') {
state[k] = d[k];
}
}
}
if (typeof state !== 'undefined') {
if (state.hp > state.max) state.hp = state.max;
if (typeof render === 'function') render();
}


// ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹: damage/storm/set
const cmd = d.cmd;
const ts = cmd && cmd.at && typeof cmd.at.toMillis === 'function' ? cmd.at.toMillis() : 0;
if (ts && ts > lastCmdAt) {
lastCmdAt = ts;
if (cmd.type === 'damage') {
if (typeof damage === 'function') damage(Math.abs(cmd.amount || 0));
}
if (cmd.type === 'storm') {
if (typeof startStorm === 'function') startStorm();
}
if (cmd.type === 'set' && cmd.patch) {
if (typeof state !== 'undefined') Object.assign(state, cmd.patch);
if (typeof render === 'function') render();
}
}
});
</script>
</body>
</html>
