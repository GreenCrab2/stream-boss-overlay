<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stream Boss — Пульт</title>
  <style>
    :root{ --fg:#f2f2f7; --bg:#0f0f14; --card:#1b1b22; --line:#2a2a33; --muted:#c7c7d0; --red:#ff6b6b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
    h1{margin:6px 0 12px;font-size:22px}
    label{display:block;font-size:14px;margin:10px 0 6px;color:var(--muted)}
    input{width:100%;padding:10px;border:1px solid #34343f;border-radius:10px;background:#0f0f14;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{cursor:pointer;display:inline-block;padding:12px 14px;border-radius:10px;background:#2b2b36;border:1px solid #3b3b48;color:#fff;font-weight:700;margin:6px 8px 0 0}
    .btn:active{transform:translateY(1px)}
    .good{background:#2e6048;border-color:#3e8462}
    .danger{background:#613040;border-color:#8a4b5f}
    .muted{background:#2b2b36;border-color:#3b3b48}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    code{background:#0c0c10;border:1px solid #2a2a33;border-radius:8px;padding:4px 6px;display:inline-block}
    .error{border-color:#8a4b5f}
    .error h1{color:var(--red)}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Stream Boss — Пульт</h1>

  <div class="card" id="configError" style="display:none"></div>

  <div class="card">
    <div><b>Комната:</b> <span id="roomTxt"></span></div>
    <div id="authBox" style="margin-top:8px">
      <button id="loginBtn" class="btn good">Войти через Google (админ)</button>
      <button id="logoutBtn" class="btn muted" style="display:none">Выйти</button>
      <button id="forkBtn" class="btn" style="display:none">Сделать личную комнату</button>
      <span id="who" style="opacity:.8;margin-left:8px"></span>
    </div>
    <div class="hint">Войдите один раз, чтобы создать комнату и управлять ею. Оверлей читает без входа.</div>
  </div>

  <div class="card">
    <h1>Быстрые действия</h1>
    <div>
      <button class="btn danger" data-dmg="1">Осуждающий взгляд — −1</button>
      <button class="btn danger" data-dmg="5">Удар клешней — −5</button>
      <button class="btn danger" data-dmg="10">Две клешни — −10</button>
      <button class="btn danger" id="stormBtn">Призыв дождя — −50 (авто)</button>
    </div>
    <div class="hint">Шторм сам наносит тики урона до −50 HP.</div>
  </div>

  <div class="card">
    <h1>Параметры</h1>
    <div class="row">
      <div>
        <label>Имя босса</label>
        <input id="boss" placeholder="Тунг Тунг Тунг Саур">
      </div>
      <div>
        <label>Картинка (URL)</label>
        <input id="boss_img" placeholder="https://...png">
      </div>
    </div>
    <div class="row">
      <div>
        <label>HP текущие</label>
        <input id="hp" type="number" min="1" step="1">
      </div>
      <div>
        <label>HP максимум</label>
        <input id="max" type="number" min="1" step="1">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Подзаголовок</label>
        <input id="subtitle" placeholder="СЕЗОН 0 | ...">
      </div>
      <div>
        <label>Большой заголовок</label>
        <input id="titlebig" placeholder="СТОЛКНОВЕНИЕ">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Позиция X (%)</label>
        <input id="x" type="number" step="0.1">
      </div>
      <div>
        <label>Ширина (px)</label>
        <input id="w" type="number" min="800" max="1720">
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="btn good" id="saveBtn">Сохранить</button>
      <button class="btn muted" id="resetBtn">Сбросить HP</button>
    </div>
  </div>

  <div class="card">
    <h1>Подключение OBS</h1>
    <div class="hint">
      В OBS добавь Browser Source URL:
      <div><code id="obsUrl"></code></div>
    </div>
  </div>

  <div class="card" id="diag" style="display:none"></div>
</div>

<!-- ЛОГИКА ПУЛЬТА -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // --- Конфиг Firebase (вставлен из консоли) ---
  const firebaseConfig = {
    apiKey: "AIzaSyADwdDLpb5Qb2fuDx5vWC3-_BAX4S7ZiJk",
    authDomain: "mini-app-adventure.firebaseapp.com",
    projectId: "mini-app-adventure",
    storageBucket: "mini-app-adventure.firebasestorage.app",
    messagingSenderId: "537034908749",
    appId: "1:537034908749:web:26edebdf7d9fa2b42a2804",
    measurementId: "G-0RF2PPHQN8"
  };

  // --- Firebase init ---
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- Room & helpers ---
  const qs = new URLSearchParams(location.search);
  const selfMode = qs.get('self') === '1';
  const baseRoom = qs.get('room') || 'demo';

  const $ = (id)=>document.getElementById(id);

  let roomId = baseRoom;
  let roomRef = doc(db, 'rooms', roomId);

  function setRoom(id){
    roomId = id;
    roomRef = doc(db, 'rooms', roomId);
    if ($('roomTxt')) $('roomTxt').textContent = roomId;
    if ($('obsUrl')) {
      const overlayUrl = new URL('./overlay.html', location.href);
      overlayUrl.search = `room=${encodeURIComponent(roomId)}&remote_only=1`;
      $('obsUrl').textContent = overlayUrl.toString();
    }
  }
  setRoom(roomId);

  const inputs = ['boss','boss_img','hp','max','subtitle','titlebig','x','w']
    .reduce((acc,id)=>(acc[id]=$(id),acc),{});

  // --- Auth ---
  const provider = new GoogleAuthProvider();
  if ($('loginBtn')) $('loginBtn').onclick = ()=> signInWithPopup(auth, provider).catch(console.error);
  if ($('logoutBtn')) $('logoutBtn').onclick = ()=> signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    if ($('who')) $('who').textContent = user ? `Вошёл: ${user.displayName||user.email}` : '';
    if ($('loginBtn')) $('loginBtn').style.display = user ? 'none' : 'inline-block';
    if ($('logoutBtn')) $('logoutBtn').style.display = user ? 'inline-block' : 'none';
    if ($('forkBtn')) $('forkBtn').style.display = user ? 'inline-block' : 'none';

    if (!user) return;

    // SELF MODE: у каждого своя комната u_XXXXXXXX
    if (selfMode) {
      const myRoom = `u_${user.uid.slice(0,8)}`;
      setRoom(myRoom);

      const snap = await getDoc(roomRef);
      if (!snap.exists()) {
        // Берём за образец базовую комнату (если есть), иначе дефолт
        let base = null;
        try { const baseSnap = await getDoc(doc(db,'rooms', baseRoom)); base = baseSnap.exists() ? baseSnap.data() : null; } catch(_){}
        const defaults = base || {
          boss: 'Тунг Тунг Тунг Саур', boss_img: 'https://i.imgur.com/hwJZoMX.png',
          max: 500, hp: 500, subtitle: 'СЕЗОН 0 | хеллоуинский портал', titlebig: 'СТОЛКНОВЕНИЕ',
          x: 38, w: 1200, auto_restart: false, defeated: false, public: true
        };
        await setDoc(roomRef, { ...defaults, owner: user.uid, admins: [user.uid], createdAt: serverTimestamp() });
      } else {
        const d = snap.data();
        const ops = {};
        if (!d.owner) ops.owner = user.uid;
        if (!Array.isArray(d.admins) || !d.admins.includes(user.uid)) ops.admins = (Array.isArray(d.admins) ? [...d.admins, user.uid] : [user.uid]);
        if (Object.keys(ops).length) await updateDoc(roomRef, ops);
      }
      return; // не трогаем общую комнату
    }

    // ОБЩАЯ КОМНАТА (как раньше): создаём при первом заходе
    const snap = await getDoc(roomRef);
    if (!snap.exists()) {
      const defaults = {
        boss: 'Тунг Тунг Тунг Саур', boss_img: 'https://i.imgur.com/hwJZoMX.png',
        max: 500, hp: 500, subtitle: 'СЕЗОН 0 | хеллоуинский портал', titlebig: 'СТОЛКНОВЕНИЕ',
        x: 38, w: 1200, auto_restart: false, defeated: false, public: true,
        owner: user.uid, admins: [user.uid], createdAt: serverTimestamp()
      };
      await setDoc(roomRef, defaults);
    } else {
      const d = snap.data();
      if (Array.isArray(d.admins) && !d.admins.includes(user.uid)) {
        try { await updateDoc(roomRef, { admins: [...d.admins, user.uid] }); } catch(e) { /* правило может запретить — ок */ }
      }
      if (!d.owner) { try { await updateDoc(roomRef, { owner: user.uid }); } catch(_){} }
    }
  });

  // --- Live sync формы ---
  onSnapshot(roomRef, (snap)=>{
    if (!snap.exists()) return;
    const d = snap.data();
    for (const k in inputs) if (inputs[k] && d[k] !== undefined) inputs[k].value = d[k];
  });

  // --- Сохранить параметры ---
  if ($('saveBtn')) $('saveBtn').onclick = async ()=>{
    const patch = {};
    for (const k in inputs) {
      let v = inputs[k]?.value;
      if (v === undefined) continue;
      if (['hp','max','x','w'].includes(k)) v = Number(v);
      patch[k] = v;
    }
    await updateDoc(roomRef, patch);
    await updateDoc(roomRef, { cmd: { type:'set', patch:{}, at: serverTimestamp() } });
  };

  // --- Быстрый урон ---
  document.querySelectorAll('[data-dmg]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const n = Number(btn.dataset.dmg)||0;
      await updateDoc(roomRef, { cmd: { type:'damage', amount:n, at: serverTimestamp() } });
    });
  });

  // --- Шторм ---
  if ($('stormBtn')) $('stormBtn').onclick = async ()=>{
    await updateDoc(roomRef, { cmd: { type:'storm', at: serverTimestamp() } });
  };

  // --- Сброс HP ---
  if ($('resetBtn')) $('resetBtn').onclick = async ()=>{
    const snap = await getDoc(roomRef);
    const d = snap.data();
    const max = d?.max ?? 500;
    await updateDoc(roomRef, { hp: max, defeated: false, cmd: { type:'set', patch:{hp:max, defeated:false}, at: serverTimestamp() } });
  };

  // --- Fork: создать личную комнату из текущей ---
  if ($('forkBtn')) $('forkBtn').onclick = async ()=>{
    const user = auth.currentUser; if (!user) return alert('Сначала войдите');
    const myRoom = `u_${user.uid.slice(0,8)}`;
    // берём текущие значения как шаблон
    let base = null;
    try { const snap = await getDoc(roomRef); base = snap.exists() ? snap.data() : null; } catch(_){}
    const newRef = doc(db,'rooms', myRoom);
    await setDoc(newRef, {
      ...(base || {
        boss: 'Тунг Тунг Тунг Саур', boss_img: 'https://i.imgur.com/hwJZoMX.png',
        max: 500, hp: 500, subtitle: 'СЕЗОН 0 | хеллоуинский портал', titlebig: 'СТОЛКНОВЕНИЕ',
        x: 38, w: 1200, auto_restart: false, defeated: false, public: true
      }),
      owner: user.uid, admins: [user.uid], createdAt: serverTimestamp()
    });
    setRoom(myRoom);
    alert('Личная комната создана. Ссылка для OBS обновлена выше.');
  };

  // --- Диагностика (включается ?debug=1) ---
  if (qs.get('debug') === '1'){
    const box = document.getElementById('diag');
    box.style.display = 'block';
    box.innerHTML = `<h1>Диагностика</h1><div class="hint mono">projectId: ${firebaseConfig.projectId}</div><div class="hint mono">roomId: ${roomId}</div>`;
    try{
      const test = await getDoc(roomRef);
      box.innerHTML += `<div class="hint">Firestore доступен: <b>${test ? 'OK' : 'нет данных'}</b></div>`;
    }catch(e){
      box.innerHTML += `<div class="hint" style="color:var(--red)">Ошибка Firestore: ${e.message}</div>`;
    }
  }
</script>
</body>
</html>
