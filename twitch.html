<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Twitch Bridge → Stream Boss</title>
  <style>
    body{
      margin:0;padding:16px;
      background:#05060a;color:#f7f7ff;
      font-family:system-ui,Segoe UI,Inter,Roboto,sans-serif;
      white-space:pre-wrap;line-height:1.4;
    }
    h1{font-size:18px;margin:0 0 10px;}
    .btn{
      display:inline-block;
      margin:0 8px 8px 0;
      padding:8px 14px;
      border-radius:8px;
      border:1px solid #333645;
      background:#1e2230;
      color:#fff;
      font-weight:600;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px);}
  </style>
</head>
<body>
<h1>Twitch ↔ Stream Boss мост</h1>
<div>
  <button id="twLogin" class="btn">Войти в Twitch</button>
  <button id="twReset" class="btn">Сбросить токен</button>
  <button id="gLogin" class="btn">Войти в Google (Firebase)</button>
</div>
<div id="who" style="margin:4px 0 8px;opacity:.9"></div>
<hr/>
<div id="log"></div>

<script type="module">
  // ================= НАСТРОЙКИ =================
  const CLIENT_ID    = 'l8kchqfp0vdlva741gcj6hkvkw08jb';      // твой Twitch Client ID
  const REWARD_TITLE = 'Применить способность';               // точное название награды
  const ROOM_ID      = new URLSearchParams(location.search).get('room') || 'demo';

  // Firebase (как в control/overlay)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyADwdDLpb5Qb2fuDx5vWC3-_BAX4S7ZiJk",
    authDomain: "mini-app-adventure.firebaseapp.com",
    projectId: "mini-app-adventure",
    storageBucket: "mini-app-adventure.firebasestorage.app",
    messagingSenderId: "537034908749",
    appId: "1:537034908749:web:26edebdf7d9fa2b42a2804",
    measurementId: "G-0RF2PPHQN8"
  };

  // ================= УТИЛИТЫ =================
  const logEl = document.getElementById('log');
  const log = (...a) => {
    console.log(...a);
    logEl.textContent += a.join(' ') + '\n';
  };

  log('REDIRECT_URI:', location.origin + location.pathname);
  log('Комната:', ROOM_ID);
  log('');

  // ================= Firebase =================
  import {
    initializeApp
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getFirestore, doc, updateDoc, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

  const fbApp  = initializeApp(FIREBASE_CONFIG);
  const db     = getFirestore(fbApp);
  const auth   = getAuth(fbApp);
  const roomRef = doc(db, 'rooms', ROOM_ID);
  const provider = new GoogleAuthProvider();

  const who = document.getElementById('who');
  const gLoginBtn = document.getElementById('gLogin');

  gLoginBtn.onclick = () => signInWithPopup(auth, provider).catch(e => log('Firebase auth error:', e));

  onAuthStateChanged(auth, user => {
    if (user) {
      who.textContent = `Вошли в Google: ${user.displayName || user.email}`;
    } else {
      who.textContent = 'Не вошли в Google. Для записи в Firestore нужен вход.';
    }
  });

  // ================= Twitch OAuth (implicit flow) =================
  const TOKEN_KEY = 'tw_access_token_v1';

  function getRedirectUri() {
    return location.origin + location.pathname; // twitch.html
  }

  function saveToken(token) {
    localStorage.setItem(TOKEN_KEY, token);
  }
  function loadToken() {
    return localStorage.getItem(TOKEN_KEY) || null;
  }
  function clearToken() {
    localStorage.removeItem(TOKEN_KEY);
  }

  // Парсим access_token из hash, если Twitch только что вернул
  (function parseHashToken() {
    if (!location.hash) return;
    const params = new URLSearchParams(location.hash.slice(1));
    const token = params.get('access_token');
    if (token) {
      saveToken(token);
      log('Найден access_token в URL, сохранён в localStorage.');
      // чистим hash, чтобы не мешал
      history.replaceState({}, document.title, location.pathname + location.search);
    }
  })();

  async function validateToken(token) {
    try {
      const res = await fetch('https://id.twitch.tv/oauth2/validate', {
        headers: { 'Authorization': 'OAuth ' + token }
      });
      if (!res.ok) {
        log('Validate failed, status', res.status);
        return null;
      }
      const data = await res.json();
      log('Token scopes:', (data.scopes || []).join(', ') || '(нет)');
      log(`Twitch: ${data.login}  (id ${data.user_id})`);
      return data;
    } catch (e) {
      log('Ошибка validate:', e);
      return null;
    }
  }

  function startOAuth() {
    const redirect_uri = encodeURIComponent(getRedirectUri());
    const scope = encodeURIComponent('channel:read:redemptions');
    const state = Math.random().toString(36).slice(2);
    const url =
      `https://id.twitch.tv/oauth2/authorize` +
      `?client_id=${CLIENT_ID}` +
      `&redirect_uri=${redirect_uri}` +
      `&response_type=token` +
      `&scope=${scope}` +
      `&force_verify=true` +
      `&state=${state}`;
    location.href = url;
  }

  document.getElementById('twLogin').onclick = () => startOAuth();
  document.getElementById('twReset').onclick = () => {
    clearToken();
    log('Токен очищен. Нажми «Войти в Twitch».');
  };

  // ================= PubSub =================
  let pubsub = null;
  let pubsubUserId = null;
  let pubsubToken  = null;

  function connectPubSub() {
    if (!pubsubUserId || !pubsubToken) {
      log('PubSub: нет userId или токена');
      return;
    }

    const topic = `channel-points-channel-v1.${pubsubUserId}`;
    log('PubSub: подключаемся к', topic);

    const ws = new WebSocket('wss://pubsub-edge.twitch.tv');
    pubsub = ws;

    ws.onopen = () => {
      log('WS(PubSub): open');
      const msg = {
        type: 'LISTEN',
        nonce: Math.random().toString(36).slice(2),
        data: {
          topics: [topic],
          auth_token: pubsubToken
        }
      };
      ws.send(JSON.stringify(msg));
    };

    ws.onmessage = ev => {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'RESPONSE') {
        if (msg.error) log('PubSub RESPONSE error:', msg.error);
        else           log('PubSub RESPONSE ok, nonce', msg.nonce);
      }
      if (msg.type === 'MESSAGE') {
        try {
          const m = JSON.parse(msg.data.message);
          const red = m.data?.redemption;
          const title = red?.reward?.title;
          const user  = red?.user?.display_name || red?.user?.login;
          log('Redeem:', title, 'от', user);
          if (title === REWARD_TITLE) {
            triggerRandomSkill(user);
          }
        } catch (e) {
          log('Ошибка парсинга MESSAGE:', e);
        }
      }
      if (msg.type === 'PONG') {
        // пинг-понг, можно игнорировать
      }
    };

    ws.onclose = () => {
      log('WS(PubSub): close → reconnect через 15с…');
      setTimeout(connectPubSub, 15000);
    };

    // Пинги раз в 4 минуты, чтобы соединение не умерло
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'PING' }));
      }
    }, 4 * 60 * 1000);
  }

  // ================= Связка с Firestore / оверлеем =================
  async function triggerRandomSkill(userName) {
    if (!auth.currentUser) {
      log('Награда получена, но в Google не вошли — запись в Firestore отменена.');
      return;
    }
    try {
      await updateDoc(roomRef, {
        cmd: {
          type: 'randomSkill',
          from: userName || null,
          at: serverTimestamp()
        }
      });
      log('→ Firestore: записана команда randomSkill');
    } catch (e) {
      log('Ошибка записи в Firestore:', e);
    }
  }

  // ================= Старт =================
  (async function boot() {
    const token = loadToken();
    if (!token) {
      log('Токен не найден. Нажми «Войти в Twitch».');
      return;
    }

    log('Токен найден в localStorage, проверяем…');
    const info = await validateToken(token);
    if (!info) {
      clearToken();
      log('Токен невалиден или истёк. Нажми «Войти в Twitch».');
      return;
    }

    pubsubUserId = info.user_id;
    pubsubToken  = token;
    log('');
    log(`Готово: ждём редемпы «${REWARD_TITLE}»…`);
    log('');
    connectPubSub();
  })();
</script>
</body>
</html>
