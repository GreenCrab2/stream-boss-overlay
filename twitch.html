<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<title>Twitch Bridge → Stream Boss</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<body style="background:#0f0f14;color:#fff;font-family:system-ui;padding:16px">
  <div id="log" style="white-space:pre-wrap;line-height:1.4"></div>

<script>
// ────────────────────────────── НАСТРОЙКИ ──────────────────────────────
const CLIENT_ID     = 'l8kchqfp0vdlva741gcj6hkvkw08jb';       // твой Client ID (Public)
const REDIRECT_URI  = location.origin + location.pathname;     // текущий twitch.html
const SCOPES        = ['channel:read:redemptions'];
const REWARD_TITLE  = 'Применить способность';                  // название награды

// Комната для Firestore берётся из ?room=...
const ROOM_ID = new URLSearchParams(location.search).get('room') || 'demo';

// Твой Firebase (как в control.html)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyADwdDLpb5Qb2fuDx5vWC3-_BAX4S7ZiJk",
  authDomain: "mini-app-adventure.firebaseapp.com",
  projectId: "mini-app-adventure",
  storageBucket: "mini-app-adventure.firebasestorage.app",
  messagingSenderId: "537034908749",
  appId: "1:537034908749:web:26edebdf7d9fa2b42a2804",
  measurementId: "G-0RF2PPHQN8"
};
// ───────────────────────────────────────────────────────────────────────

const log = (...a)=>{ const n=document.getElementById('log'); n.innerHTML += a.join(' ') + '\n'; };

// ───────────── OAuth PKCE (без секретов) ─────────────
function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
async function startPkce(){
  const verBytes = crypto.getRandomValues(new Uint8Array(32));
  const verifier = b64url(verBytes);
  const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
  const challenge = b64url(digest);
  sessionStorage.setItem('t_verifier', verifier);

  const url = new URL('https://id.twitch.tv/oauth2/authorize');
  url.searchParams.set('client_id', CLIENT_ID);
  url.searchParams.set('redirect_uri', REDIRECT_URI);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('scope', SCOPES.join(' '));
  url.searchParams.set('code_challenge', challenge);
  url.searchParams.set('code_challenge_method', 'S256');
  location.href = url.toString();
}

async function exchangeToken(code){
  const verifier = sessionStorage.getItem('t_verifier');
  const body = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: 'authorization_code',
    code,
    redirect_uri: REDIRECT_URI,
    code_verifier: verifier
  });
  const r = await fetch('https://id.twitch.tv/oauth2/token', { method:'POST', body });
  if(!r.ok){ throw new Error('Token exchange failed'); }
  return r.json(); // { access_token, refresh_token, ... }
}

async function fetchUser(accessToken){
  const r = await fetch('https://api.twitch.tv/helix/users', {
    headers:{ 'Client-ID': CLIENT_ID, 'Authorization':'Bearer '+accessToken }
  });
  const j = await r.json();
  if(!j.data?.length) throw new Error('No user from /users');
  return j.data[0]; // { id, login, display_name, ... }
}

// ───────────── EventSub WS ─────────────
let ws, sessionId;
const seen = new Set(); // защита от дублей
async function connectEventSub(accessToken, broadcasterId){
  ws = new WebSocket('wss://eventsub.wss.twitch.tv/ws');
  ws.onopen = ()=> log('WS: open');
  ws.onclose = ()=> { log('WS: close, reconnect soon'); setTimeout(()=>connectEventSub(accessToken, broadcasterId), 1500); };
  ws.onmessage = async (ev)=>{
    const msg = JSON.parse(ev.data);

    if (msg.metadata?.message_type === 'session_welcome'){
      sessionId = msg.payload.session.id;
      log('WS: welcome, session', sessionId);

      // подписка на редемпы
      await subscribeEvent('channel.channel_points_custom_reward_redemption.add', { broadcaster_user_id: broadcasterId }, accessToken);
      log('EventSub: subscribed to redemptions');
    }

    if (msg.metadata?.message_type === 'notification'){
      const type = msg.subscription?.type;
      if (type === 'channel.channel_points_custom_reward_redemption.add'){
        const e = msg.payload?.event;
        if (!e) return;
        if (seen.has(e.id)) return;
        seen.add(e.id);

        const title = e.reward?.title || '';
        log('Redemption:', title, 'by', e.user_name);

        if (title.trim().toLowerCase() === REWARD_TITLE.trim().toLowerCase()){
          // триггерим случайный скилл из первых пяти
          try{ await triggerRandomSkill(); log('→ skill triggered'); }catch(err){ log('Trigger error:', err.message); }
        } else {
          // игнорим чужие награды
        }
      }
    }
  };
}

async function subscribeEvent(type, condition, accessToken){
  await fetch('https://api.twitch.tv/helix/eventsub/subscriptions', {
    method:'POST',
    headers:{
      'Client-ID': CLIENT_ID,
      'Authorization':'Bearer ' + accessToken,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({
      type,
      version: '1',
      condition,
      transport: { method:'websocket', session_id: sessionId }
    })
  });
}

// ───────────── Firestore: выбрать 1 из первых 5 и нанести урон ─────────────
async function triggerRandomSkill(){
  const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
  const { getFirestore, doc, getDoc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

  const app = initializeApp(FIREBASE_CONFIG);
  const db  = getFirestore(app);

  const ref  = doc(db,'rooms',ROOM_ID);
  const snap = await getDoc(ref);
  if(!snap.exists()) throw new Error('room not found');
  const d = snap.data();
  const list = (d.actions||[]).slice(0,5).filter(x=>x?.label && Number(x?.dmg)>0);

  if(!list.length) throw new Error('no actions configured');
  const pick = list[Math.floor(Math.random()*list.length)];
  await updateDoc(ref, { cmd: { type:'damage', amount:Number(pick.dmg)||0, at: serverTimestamp() } });
}

// ───────────── boot ─────────────
(async ()=>{
  try{
    const url = new URL(location.href);
    const code = url.searchParams.get('code');

    if(!code){
      log('Открываю Twitch OAuth…');
      await startPkce();
      return;
    }

    const tokens = await exchangeToken(code);
    log('OAuth: токен получен');

    // чистим code из адреса
    history.replaceState(null,'',REDIRECT_URI + (ROOM_ID ? ('?room='+encodeURIComponent(ROOM_ID)) : ''));

    const user = await fetchUser(tokens.access_token);
    log('Twitch:', user.display_name, `(id ${user.id})`);
    await connectEventSub(tokens.access_token, user.id);
    log('Готово: ждём редемпы «' + REWARD_TITLE + '» …');
  }catch(e){
    log('Ошибка:', e.message);
  }
})();
</script>
</body>
</html>
