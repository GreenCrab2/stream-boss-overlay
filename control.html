<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stream Boss — Пульт</title>
  <style>
    :root{ --fg:#f2f2f7; --bg:#0f0f14; --card:#1b1b22; --line:#2a2a33; --muted:#c7c7d0; --red:#ff6b6b; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Inter,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
    h1{margin:6px 0 12px;font-size:22px}
    label{display:block;font-size:14px;margin:10px 0 6px;color:var(--muted)}
    input{width:100%;padding:10px;border:1px solid #34343f;border-radius:10px;background:#0f0f14;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{cursor:pointer;display:inline-block;padding:12px 14px;border-radius:10px;background:#2b2b36;border:1px solid #3b3b48;color:#fff;font-weight:700;margin:6px 8px 0 0}
    .btn:active{transform:translateY(1px)}
    .good{background:#2e6048;border-color:#3e8462}
    .muted{background:#2b2b36;border-color:#3b3b48}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    code{background:#0c0c10;border:1px solid #2a2a33;border-radius:8px;padding:4px 6px;display:inline-block}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}

    /* сетка для отображения активных кнопок */
    .qa-grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:12px}
    .qa-grid .btn{width:100%;text-align:center}
    @media (max-width:720px){.qa-grid{grid-template-columns:1fr}}

    /* ? tooltip */
    .help{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:#2b2b36;border:1px solid #3b3b48;color:#fff;font-weight:800;font-size:12px;cursor:help;position:relative}
    .help .tt{position:absolute;left:26px;top:50%;transform:translateY(-50%) translateY(4px);background:#0c0c10;border:1px solid #2a2a33;color:#f2f2f7;padding:10px 12px;border-radius:10px;min-width:260px;max-width:360px;font-size:12px;line-height:1.35;box-shadow:0 8px 30px rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .15s ease, transform .15s ease;z-index:20}
    .help:hover .tt,.help:focus .tt{opacity:1;transform:translateY(-50%)}

    /* ====== ТОЛЬКО для «Настройка быстрых действий» ====== */
    .qa-settings .qa-row{
      display:grid;
      grid-template-columns: minmax(240px,33%) minmax(110px,16.66%);
      column-gap: 120px;    /* свободный промежуток между колонками */
      row-gap: 10px;
      align-items:center;
    }
    .qa-settings .qa-name{ width:100%; }
    .qa-settings .qa-dmg{
      width:100%;
      max-width: clamp(110px, 16.66%, 220px);
      text-align:right;
    }
    /* НЕ переносить конкретную подпись */
    .qa-settings label.nowrap{ white-space: nowrap; }

    @media (max-width: 720px){
      .qa-settings .qa-row{
        grid-template-columns: 1fr minmax(110px,33%);
        column-gap: 20px;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Stream Boss — Пульт</h1>

  <div class="card">
    <div id="authBox" style="margin-top:8px; display:flex; align-items:center; gap:10px;">
      <button id="loginBtn" class="btn good">Войти через Google (админ)</button>
      <button id="logoutBtn" class="btn muted" style="display:none">Выйти</button>
      <span id="who" style="opacity:.8;"></span>
    </div>
    <div class="hint" style="display:flex;align-items:center;gap:8px;">
      <span class="help" tabindex="0">?
        <span class="tt">
          Войдите один раз, чтобы создать комнату и управлять ею. Оверлей читает без входа.
          Личная комната помогает сохранять свои настройки.
        </span>
      </span>
    </div>
  </div>

  <div class="card" id="qaCard">
    <h1>Быстрые действия</h1>
    <div id="qaBtns" class="qa-grid"></div>
    <div class="hint">Пустые скиллы не отображаются. Изменяются ниже и сохраняются в комнате.</div>
  </div>

  <!-- ===== Настройка быстрых действий ===== -->
  <div class="card qa-settings">
    <h1>Настройка быстрых действий</h1>

    <div class="qa-row">
      <div><label>Название 1</label><input id="a_name1" class="qa-name" maxlength="30" placeholder="Осуждающий взгляд"></div>
      <div><label>Урон 1</label><input id="a_dmg1" class="qa-dmg" type="number" min="1" max="99999" step="1" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div class="qa-row">
      <div><label>Название 2</label><input id="a_name2" class="qa-name" maxlength="30"></div>
      <div><label>Урон 2</label><input id="a_dmg2" class="qa-dmg" type="number" min="1" max="99999" step="1" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div class="qa-row">
      <div><label>Название 3</label><input id="a_name3" class="qa-name" maxlength="30"></div>
      <div><label>Урон 3</label><input id="a_dmg3" class="qa-dmg" type="number" min="1" max="99999" step="1" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div class="qa-row">
      <div><label>Название 4</label><input id="a_name4" class="qa-name" maxlength="30"></div>
      <div><label>Урон 4</label><input id="a_dmg4" class="qa-dmg" type="number" min="1" max="99999" step="1" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div class="qa-row">
      <div><label>Название 5</label><input id="a_name5" class="qa-name" maxlength="30"></div>
      <div><label>Урон 5</label><input id="a_dmg5" class="qa-dmg" type="number" min="1" max="99999" step="1" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div class="qa-row" style="margin-top:10px">
      <div><label>Дополнительно — название (тики)</label><input id="extra_name" class="qa-name" maxlength="30" placeholder="Призыв дождя"></div>
      <div><label class="nowrap">Дополнительно — сумма урона</label><input id="extra_total" class="qa-dmg" type="number" min="1" max="99999" step="1" placeholder="50" inputmode="numeric" pattern="[0-9]*"></div>
    </div>

    <div style="margin-top:10px">
      <button class="btn good" id="saveActions">Сохранить действия</button>
    </div>
    <div class="hint">Название ≤ 30 символов. Урон — число 1…99999 (до 5 цифр). Пустые не отображаются.</div>
  </div>

  <div class="card">
    <h1>Параметры</h1>
    <div class="row">
      <div><label>Имя босса</label><input id="boss" placeholder="Тунг Тунг Тунг Саур"></div>
      <div><label>Картинка (URL)</label><input id="boss_img" placeholder="https://...png"></div>
    </div>
    <div class="row">
      <div><label>HP текущие</label><input id="hp" type="number" min="1" step="1"></div>
      <div><label>HP максимум</label><input id="max" type="number" min="1" step="1"></div>
    </div>
    <div class="row">
      <div><label>Подзаголовок</label><input id="subtitle" placeholder="СЕЗОН 0 | ..."></div>
      <div><label>Большой заголовок</label><input id="titlebig" placeholder="СТОЛКНОВЕНИЕ"></div>
    </div>
    <div class="row">
      <div><label>Позиция X (%)</label><input id="x" type="number" step="0.1"></div>
      <div><label>Ширина (px)</label><input id="w" type="number" min="800" max="1720"></div>
    </div>
    <div style="margin-top:10px">
      <button class="btn good" id="saveBtn">Сохранить</button>
      <button class="btn muted" id="resetBtn">Сбросить HP</button>
    </div>
  </div>

  <div class="card">
    <h1>Подключение OBS</h1>
    <div class="hint">В OBS добавь Browser Source URL:<div><code id="obsUrl"></code></div></div>
  </div>

  <div class="card" id="diag" style="display:none"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADwdDLpb5Qb2fuDx5vWC3-_BAX4S7ZiJk",
    authDomain: "mini-app-adventure.firebaseapp.com",
    projectId: "mini-app-adventure",
    storageBucket: "mini-app-adventure.firebasestorage.app",
    messagingSenderId: "537034908749",
    appId: "1:537034908749:web:26edebdf7d9fa2b42a2804",
    measurementId: "G-0RF2PPHQN8"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const qs       = new URLSearchParams(location.search);
  const baseRoom = qs.get('room') || 'demo';
  const $ = (id)=>document.getElementById(id);

  let roomId  = baseRoom;
  let roomRef = doc(db, 'rooms', roomId);

  function setRoom(id){
    roomId  = id;
    roomRef = doc(db, 'rooms', roomId);
    const overlayUrl = new URL('./overlay.html', location.href);
    overlayUrl.search = `room=${encodeURIComponent(roomId)}&remote_only=1`;
    $('obsUrl').textContent = overlayUrl.toString();
  }
  setRoom(roomId);

  const inputs = ['boss','boss_img','hp','max','subtitle','titlebig','x','w']
    .reduce((acc,id)=>(acc[id]=$(id),acc),{});

  const qaIds = [1,2,3,4,5];
  const qa = {
    names: qaIds.map(i=>document.getElementById(`a_name${i}`)),
    dmgs:  qaIds.map(i=>document.getElementById(`a_dmg${i}`)),
    extraName: document.getElementById('extra_name'),
    extraTotal: document.getElementById('extra_total'),
    btnsBox: document.getElementById('qaBtns'),
  };

  function enforceName(e){ if (e.target.value.length > 30) e.target.value = e.target.value.slice(0,30); }
  function enforceDmg(e){
    let v = String(e.target.value).replace(/\D+/g,'');
    if (v.length > 5) v = v.slice(0,5);
    let n = Number(v || 0);
    if (n > 99999) n = 99999;
    e.target.value = v ? String(n) : '';
  }
  [...qa.names, qa.extraName].forEach(el=> el?.addEventListener('input', enforceName));
  [...qa.dmgs, qa.extraTotal].forEach(el=> el?.addEventListener('input', enforceDmg));

  function buildQaButtons(actions=[], extra=null){
    qa.btnsBox.innerHTML = '';
    (actions||[]).forEach(a=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.style.background = '#613040';
      b.style.borderColor = '#8a4b5f';
      b.textContent = `${a.label} — −${a.dmg}`;
      b.addEventListener('click', async ()=>{
        await updateDoc(roomRef, { cmd: { type:'damage', amount:Number(a.dmg)||0, at: serverTimestamp() } });
      });
      qa.btnsBox.appendChild(b);
    });
    if (extra && extra.label && Number(extra.total)>0){
      const b = document.createElement('button');
      b.className = 'btn';
      b.style.background = '#613040';
      b.style.borderColor = '#8a4b5f';
      b.textContent = `${extra.label} — −${extra.total} (тики)`;
      b.addEventListener('click', async ()=>{
        await updateDoc(roomRef, { cmd: { type:'tick', total:Number(extra.total)||0, at: serverTimestamp() } });
      });
      qa.btnsBox.appendChild(b);
    }
  }

  const provider = new GoogleAuthProvider();
  $('loginBtn').onclick = ()=> signInWithPopup(auth, provider).catch(console.error);
  $('logoutBtn').onclick = ()=> signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    $('who').textContent = user ? `Вошёл: ${user.displayName||user.email}` : '';
    $('loginBtn').style.display  = user ? 'none' : 'inline-block';
    $('logoutBtn').style.display = user ? 'inline-block' : 'none';

    if (!user) { setRoom(baseRoom); return; }

    const myRoom = `u_${user.uid.slice(0,8)}`;
    setRoom(myRoom);

    const snap = await getDoc(roomRef);
    if (!snap.exists()) {
      let base = null;
      try { const bs = await getDoc(doc(db,'rooms', baseRoom)); base = bs.exists() ? bs.data() : null; } catch(_){}
      const defaults = base || {
        boss: 'Тунг Тунг Тунг Саур', boss_img: 'https://i.imgur.com/hwJZoMX.png',
        max: 500, hp: 500, subtitle: 'СЕЗОН 0 | хеллоуинский портал', titlebig: 'СТОЛКНОВЕНИЕ',
        x: 38, w: 1200, auto_restart: false, defeated: false, public: true
      };
      await setDoc(roomRef, { ...defaults, owner: user.uid, admins: [user.uid], createdAt: serverTimestamp() });
    } else {
      const d = snap.data();
      const ops = {};
      if (!d.owner) ops.owner = user.uid;
      if (!Array.isArray(d.admins) || !d.admins.includes(user.uid)) ops.admins = (Array.isArray(d.admins) ? [...d.admins, user.uid] : [user.uid]);
      if (Object.keys(ops).length) await updateDoc(roomRef, ops);
    }
  });

  onSnapshot(roomRef, (snap)=>{
    if (!snap.exists()) return;
    const d = snap.data();

    for (const k in inputs) if (inputs[k] && d[k] !== undefined) inputs[k].value = d[k];

    const actions = Array.isArray(d.actions) ? d.actions.filter(x=>x?.label && Number(x?.dmg)>0).slice(0,5) : [];
    const extra = d.extraSkill && d.extraSkill.label && Number(d.extraSkill.total)>0 ? d.extraSkill : null;

    qaIds.forEach((i,idx)=>{
      qa.names[idx].value = actions[idx]?.label || '';
      qa.dmgs[idx].value  = actions[idx]?.dmg   ?? '';
    });
    qa.extraName.value  = extra?.label || '';
    qa.extraTotal.value = extra?.total ?? '';

    buildQaButtons(actions, extra);
  });

  $('saveBtn').onclick = async ()=>{
    const patch = {};
    for (const k in inputs) {
      let v = inputs[k]?.value;
      if (v === undefined) continue;
      if (['hp','max','x','w'].includes(k)) v = Number(v);
      patch[k] = v;
    }
    await updateDoc(roomRef, patch);
    await updateDoc(roomRef, { cmd: { type:'set', patch:{}, at: serverTimestamp() } });
  };

  $('saveActions').onclick = async ()=>{
    const actions = [1,2,3,4,5].map((i,idx)=>{
      const label = (qa.names[idx].value||'').trim().slice(0,30);
      const dmgRaw = String(qa.dmgs[idx].value||'').replace(/\D+/g,'').slice(0,5);
      const dmg = Number(dmgRaw);
      return label && dmg>0 ? {label, dmg: Math.min(99999, dmg)} : null;
    }).filter(Boolean);

    const extraLabel = (qa.extraName.value||'').trim().slice(0,30);
    const extraRaw   = String(qa.extraTotal.value||'').replace(/\D+/g,'').slice(0,5);
    const extraNum   = Math.min(99999, Number(extraRaw||0));
    const extra = (extraLabel && extraNum>0) ? { label: extraLabel, total: extraNum } : null;

    const patch = { actions };
    if (extra) patch.extraSkill = extra; else patch.extraSkill = null;
    await updateDoc(roomRef, patch);
  };

  $('resetBtn').onclick = async ()=>{
    const snap = await getDoc(roomRef);
    const d = snap.data();
    const max = d?.max ?? 500;
    await updateDoc(roomRef, { hp: max, defeated: false, cmd: { type:'set', patch:{hp:max, defeated:false}, at: serverTimestamp() } });
  };

  if (qs.get('debug') === '1'){
    const box = document.getElementById('diag');
    box.style.display = 'block';
    box.innerHTML = `<h1>Диагностика</h1>
      <div class="hint mono">projectId: ${firebaseConfig.projectId}</div>
      <div class="hint mono">roomId: ${roomId}</div>`;
  }
</script>
</body>
</html>
